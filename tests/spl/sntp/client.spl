include "../array/int_array.spl";
include "../array/byte_array.spl";
include "../array/copy.spl";
include "../bitvector/intToByteArray.spl";
include "../io/fileIO.spl";

procedure constructPacket(mode: Int, version: Int)
  returns (packet: Array<Int>)
  requires emp
  requires mode < 256 && mode >= 0
  requires version < 256 && version >= 0
  ensures array(packet)
  ensures packet.length == 12
  //ensures forall i: Int:: i >= 1 && i < packet.length ==> packet[i] == 0
{
  packet := new Array<Int>(12);

  var i := 0;

  while (i < packet.length)
    invariant i >= 0 && i <= packet.length
    invariant array(packet)
    invariant forall k: Int :: 0 <= k && k < i ==> packet[k] == 0
  {
    packet[i] := 0;
    i := i + 1;
  }

  packet[0] := (packet[0] & 199) | mode;
  packet[0] := (packet[0] & 199) | version <-< 3;

  //return packet;
}

procedure client(host: Array<Int>, mode: Int, version: Int)
  returns (time: Int)
  requires mode < 256 && mode >= 0
  requires version < 256 && version >= 0
  requires array(host)
  requires host.length == 4
  requires forall i: Int:: i >= 0 && i < host.length ==> host[i] < 256 && host[i] > 0
  ensures array(host)
{
  var flags := 0;
  var fd := gopen(host, flags);

  var packet := constructPacket(mode, version);

  var buffer := copy(packet);
  var temp := gwrite(fd, buffer);

  temp := gread(fd, buffer);

  return buffer[9] * 1000000000 + (buffer[10] * (1000000000 >-> 32));
  //return flags;
}
